# Codebase Report: Artifacts Browser Implementation
Generated: 2026-02-12 02:00:00

## Summary

The Artifacts Browser is a full-featured file explorer modal built into the Nuxt dashboard. It provides read-only browsing and editing of files within the `/var/www/vibe-marketing` directory tree, with security sandboxing via path sanitization.

**Key Features:**
- File tree navigation with lazy-loading
- Monaco editor for text files (30+ formats)
- Image, video, PDF preview
- File editing with save functionality (Ctrl/Cmd+S)
- Security-sandboxed to `/var/www/vibe-marketing`
- Default view: `projects/` directory

---

## Questions Answered

### Q1: How does ArtifactsBrowser.vue work?

**Location:** `/var/www/vibe-marketing/dashboard/components/ArtifactsBrowser.vue` (525 lines)

**Architecture:**
- **Modal state:** Managed by `useArtifactsBrowser()` composable (shared singleton)
- **Layout:** Teleported full-screen modal with 2-panel split (tree + viewer)
- **File tree:** Lazy-loaded via `fetchDirectory()` API calls
- **Rendering:** Recursive `TreeNodeItem` components

**Data Flow:**
```
User clicks node â†’ toggleDirectory/selectFile â†’ fetchDirectory('/path')
  â†“
API: GET /api/files?path=/path â†’ returns { entries: FileEntry[] }
  â†“
Update tree state (node.children, node.expanded)
  â†“
If file selected â†’ GET /api/file-content?path=/path â†’ Monaco editor
```

**File Type Detection:**
- Text files (30+ extensions) â†’ Monaco editor with syntax highlighting
- Images (.png, .jpg, .gif, .svg, .webp) â†’ `<img>` tag via `/api/file-serve`
- Videos (.mp4, .webm) â†’ `<video>` tag
- PDFs â†’ `<iframe>` embed
- Unknown â†’ Download link with metadata

**Key State Variables:**
```typescript
treeRoots: TreeNode[]           // Root-level files/folders
selectedFile: FileEntry | null  // Currently selected file
fileContent: string             // Editor content
fileDirty: boolean              // Unsaved changes flag
```

**API Calls:**
1. `GET /api/files?path=/projects` â†’ List directory
2. `GET /api/file-content?path=/projects/foo/bar.md` â†’ Read text file
3. `POST /api/file-content` body: `{ path, content }` â†’ Save text file
4. `GET /api/file-serve?path=/path/to/image.png` â†’ Serve binary files

---

### Q2: How does useArtifactsBrowser.ts work?

**Location:** `/var/www/vibe-marketing/dashboard/composables/useArtifactsBrowser.ts` (25 lines)

**Pattern:** Module-level singleton state (shared across all components)

```typescript
// Module-level state (outside function)
const isOpen = ref(false)
const initialPath = ref<string | null>(null)

// Exported composable
export function useArtifactsBrowser() {
  function open(path?: string) {
    isOpen.value = true
    initialPath.value = path || null
  }

  function close() {
    isOpen.value = false
    initialPath.value = null
  }

  return {
    isOpen: readonly(isOpen),      // Read-only access
    initialPath: readonly(initialPath),
    open,
    close,
  }
}
```

**Usage:**
```vue
// In default.vue layout
const { open: openArtifacts } = useArtifactsBrowser()
<button @click="openArtifacts()">...</button>

// In ArtifactsBrowser.vue
const { isOpen, initialPath, close } = useArtifactsBrowser()
<div v-if="isOpen">...</div>
```

**Path Handling:**
- If `initialPath` provided â†’ auto-navigate to that file on open
- Path segments split by `/` and traversed via `toggleDirectory()` calls
- Example: `open('/projects/gymzilla/campaigns/promo/brief.md')` â†’ expands tree to that file

---

### Q3: What do the server/api endpoints do?

**Location:** `/var/www/vibe-marketing/dashboard/server/api/`

#### `/api/files` (GET) - List Directory
**File:** `files.get.ts` (78 lines)

```typescript
GET /api/files?path=/projects/foo
â†’ Returns: { entries: FileEntry[] }

FileEntry {
  name: string          // "campaign.md"
  isDirectory: boolean  // false
  path: string          // "/projects/foo/campaign.md" (relative to /var/www/vibe-marketing)
  size?: number         // 4096 bytes
  modified?: string     // "2026-02-12T00:00:00.000Z"
}
```

**Logic:**
1. Sanitize path via `sanitizePath()` (default: `/var/www/vibe-marketing/projects`)
2. Check `isAllowedPath()` (must be within `/var/www/vibe-marketing`)
3. `readdir()` with `withFileTypes: true`
4. Filter hidden files (starts with `.`)
5. Sort: directories first, then alphabetical
6. Return relative paths (stripped `/var/www/vibe-marketing` prefix)

---

#### `/api/file-content` (GET) - Read Text File
**File:** `file-content.get.ts` (83 lines)

```typescript
GET /api/file-content?path=/projects/foo/bar.md
â†’ Returns: { content: string, mimeType: string, size: number, modified: string }
```

**Allowed Extensions:**
`.md`, `.txt`, `.json`, `.yaml`, `.yml`, `.html`, `.css`, `.js`, `.ts`, `.vue`, `.jsx`, `.tsx`, `.xml`, `.csv`, `.toml`, `.ini`, `.cfg`, `.conf`, `.sh`, `.bash`, `.py`, `.rb`, `.go`, `.rs`, `.java`, `.c`, `.cpp`, `.h`, `.env`, `.gitignore`, `.dockerfile`, `.sql`

**Logic:**
1. Sanitize + validate path
2. Check file extension is in `TEXT_EXTENSIONS`
3. `readFile(path, 'utf-8')`
4. Return content + metadata

---

#### `/api/file-content` (POST) - Save Text File
**File:** `file-content.post.ts` (75 lines)

```typescript
POST /api/file-content
Body: { path: string, content: string }
â†’ Returns: { success: true }
```

**Writable Extensions:**
Same as readable text extensions minus `.env`, `.gitignore`, `.dockerfile`

**Logic:**
1. Validate body has `path` and `content`
2. Sanitize + validate path
3. Check extension is writable
4. **Verify file exists** (stat check) - won't create new files
5. `writeFile(path, content, 'utf-8')`

**Important:** This endpoint ONLY updates existing files, never creates new ones.

---

#### `/api/file-serve` (GET) - Serve Binary Files
**File:** `file-serve.get.ts` (82 lines)

```typescript
GET /api/file-serve?path=/projects/foo/image.png
â†’ Returns: Binary content with Content-Type header
```

**Supported Types:**
- Images: `.png`, `.jpg`, `.jpeg`, `.gif`, `.svg`, `.webp`, `.ico`
- Videos: `.mp4`, `.webm`
- Documents: `.pdf`, `.zip`, `.tar`, `.gz`

**Headers:**
```
Content-Type: image/png
Content-Length: 123456
Cache-Control: public, max-age=3600
```

---

#### `/api/dispatch` (POST) - Task Dispatch
**File:** `dispatch.post.ts` (25 lines)

```typescript
POST /api/dispatch
Body: { taskId: string, agentName: string }
â†’ Proxies to: http://127.0.0.1:3212/dispatch
```

Unrelated to artifacts browser - used for agent task dispatch.

---

### Q4: What is the path sanitization logic?

**Location:** `/var/www/vibe-marketing/dashboard/server/utils/pathSanitizer.ts` (38 lines)

**Security Model:**
```typescript
ALLOWED_BASE = '/var/www/vibe-marketing'
DEFAULT_ROOT = '/var/www/vibe-marketing/projects'
```

#### `sanitizePath(inputPath)`
Converts user input to absolute path within allowed base.

**Examples:**
```typescript
sanitizePath('/')                â†’ '/var/www/vibe-marketing/projects'
sanitizePath('/projects')        â†’ '/var/www/vibe-marketing/projects'
sanitizePath('/artifacts/foo')   â†’ '/var/www/vibe-marketing/artifacts/foo'
sanitizePath('../../etc/passwd') â†’ '/var/www/vibe-marketing/projects' (sanitized)
```

**Logic:**
1. Empty/root path â†’ return `DEFAULT_ROOT`
2. Strip leading `/` and resolve against `ALLOWED_BASE`
3. If outside allowed base â†’ return `DEFAULT_ROOT`

#### `isAllowedPath(resolvedPath)`
Checks if absolute path is within allowed base.

**Logic:**
1. Reject paths with null bytes (`\0`)
2. Normalize via `path.resolve()`
3. Check: `resolved === ALLOWED_BASE || resolved.startsWith(ALLOWED_BASE + '/')`

**Path Traversal Protection:**
```typescript
// These all resolve to /var/www/vibe-marketing/projects
sanitizePath('/../../../etc/passwd')
sanitizePath('/projects/../../etc')
```

---

### Q5: Where is the Artifacts button in the layout?

**Location:** `/var/www/vibe-marketing/dashboard/layouts/default.vue` (165 lines)

**Topbar Structure (lines 127-155):**
```vue
<div class="sticky top-0 z-20 h-14 border-b bg-background/95 backdrop-blur">
  <!-- Left: Breadcrumbs -->
  <nav>
    <template v-for="(crumb, i) in breadcrumbs">
      Home > Projects > gymzilla > Campaigns
    </template>
  </nav>

  <!-- Right: Actions -->
  <div class="flex items-center gap-2">
    <!-- Artifacts Browser Button -->
    <button
      class="w-8 h-8 rounded-md text-muted-foreground hover:text-foreground hover:bg-muted"
      title="Artifacts Browser"
      @click="openArtifacts()"
    >
      <FolderOpen :size="18" />
    </button>

    <!-- Notification Dropdown -->
    <NotificationDropdown />
  </div>
</div>
```

**Rendering:**
```vue
<script setup>
const { open: openArtifacts } = useArtifactsBrowser()
</script>

<template>
  <main class="min-h-screen ml-60">
    <!-- Topbar with artifacts button -->
    ...
    <!-- Page content -->
    <slot />
  </main>

  <!-- Modal component (hidden until opened) -->
  <ArtifactsBrowser />
</template>
```

**Breadcrumbs Logic:**
Maps route segments to labels:
```typescript
Route: /projects/gymzilla/campaigns/promo
Breadcrumbs: Home > Projects > gymzilla > Campaigns > promo
```

---

### Q6: How does routing determine project context?

**Pattern:** Nuxt file-based routing with `[slug]` dynamic segments

**Route Structure:**
```
pages/
  index.vue                      â†’ /                    (global)
  agents.vue                     â†’ /agents              (global)
  activity.vue                   â†’ /activity            (global)
  services.vue                   â†’ /services            (global)
  pipelines/
    index.vue                    â†’ /pipelines           (global)
  projects/
    index.vue                    â†’ /projects            (global)
    new.vue                      â†’ /projects/new        (global)
    [slug].vue                   â†’ /projects/:slug      (PROJECT CONTEXT)
      index.vue                  â†’ /projects/:slug/
      pipeline.vue               â†’ /projects/:slug/pipeline
      products/
        index.vue                â†’ /projects/:slug/products
        [id].vue                 â†’ /projects/:slug/products/:id
      audiences/
        index.vue                â†’ /projects/:slug/audiences
        [fgId].vue               â†’ /projects/:slug/audiences/:fgId
      campaigns/
        index.vue                â†’ /projects/:slug/campaigns
        [id].vue                 â†’ /projects/:slug/campaigns/:id
  settings/
    index.vue                    â†’ /settings            (global)
    notifications.vue            â†’ /settings/notifications (global)
```

**Project Context Detection:**

Any route under `/projects/[slug]/*` is a **project-scoped page**.

**Example:** `/var/www/vibe-marketing/dashboard/pages/projects/[slug].vue` (layout wrapper)

```vue
<script setup>
const { project, loading } = useCurrentProject()  // Fetches project by route.params.slug
const route = useRoute()
const slug = computed(() => route.params.slug as string)

const tabs = computed(() => [
  { name: 'Overview', path: `/projects/${slug.value}` },
  { name: 'Products', path: `/projects/${slug.value}/products` },
  { name: 'Audiences', path: `/projects/${slug.value}/audiences` },
  { name: 'Campaigns', path: `/projects/${slug.value}/campaigns` },
  { name: 'Pipeline', path: `/projects/${slug.value}/pipeline` },
])
</script>

<template>
  <div>
    <!-- Project header with tabs -->
    <h1>{{ project.name }}</h1>
    <nav>
      <NuxtLink v-for="tab in tabs" :to="tab.path">
        {{ tab.name }}
      </NuxtLink>
    </nav>

    <!-- Nested child page (e.g., campaigns/index.vue) -->
    <NuxtPage />
  </div>
</template>
```

**How `useCurrentProject()` works (inferred from usage):**
```typescript
// composables/useCurrentProject.ts (not read, but implied)
export function useCurrentProject() {
  const route = useRoute()
  const slug = computed(() => route.params.slug as string)

  const { data: project, loading } = useConvexQuery(
    api.projects.getBySlug,
    { slug: slug.value }
  )

  return { project, loading }
}
```

**Global vs Project Pages:**

| Route Pattern | Context | Example |
|---------------|---------|---------|
| `/agents` | Global | All agents across all projects |
| `/pipelines` | Global | All pipeline templates |
| `/services` | Global | All registered external services |
| `/activity` | Global | All recent activity across projects |
| `/projects/:slug/*` | **Project** | Project-specific data (campaigns, products, audiences) |

---

### Q7: How does TreeNodeItem.vue work?

**Location:** `/var/www/vibe-marketing/dashboard/components/TreeNodeItem.vue` (122 lines)

**Pattern:** Recursive component for tree rendering

**Props:**
```typescript
interface TreeNode {
  name: string
  isDirectory: boolean
  path: string
  size?: number
  modified?: string
  children?: TreeNode[]
  expanded?: boolean
  loading?: boolean
}

props: {
  node: TreeNode
  depth: number          // Indentation level (0, 1, 2, ...)
  selectedPath: string   // Currently selected file path
}
```

**Emits:**
```typescript
emit('toggle', node)  // User clicked directory (expand/collapse)
emit('select', node)  // User clicked file
```

**Rendering Logic:**
```vue
<div>
  <!-- Node button -->
  <button
    :style="{ paddingLeft: `${depth * 16 + 8}px` }"
    :class="isSelected ? 'bg-primary/10 text-primary' : 'text-foreground'"
    @click="handleClick"
  >
    <!-- Chevron (directories only) -->
    <ChevronDown v-if="node.expanded" />
    <ChevronRight v-else-if="node.isDirectory" />
    <Loader2 v-if="node.loading" class="animate-spin" />

    <!-- Icon (type-based) -->
    <component :is="getFileIcon(node)" :class="getFileIconColor(node)" />

    <!-- Name -->
    <span>{{ node.name }}</span>
  </button>

  <!-- Children (recursive, only if directory expanded) -->
  <template v-if="node.isDirectory && node.expanded && node.children">
    <TreeNodeItem
      v-for="child in node.children"
      :key="child.path"
      :node="child"
      :depth="depth + 1"
      :selected-path="selectedPath"
      @toggle="emit('toggle', $event)"
      @select="emit('select', $event)"
    />
  </template>
</div>
```

**Icon Selection:**
```typescript
function getFileIcon(node) {
  if (node.isDirectory) return node.expanded ? FolderOpen : Folder

  const ext = getExtension(node.name)
  if (IMAGE_EXTENSIONS.has(ext)) return FileImage
  if (VIDEO_EXTENSIONS.has(ext)) return FileVideo
  if (CODE_EXTENSIONS.has(ext)) return FileCode
  if (TEXT_EXTENSIONS.has(ext)) return FileText
  return File
}

function getFileIconColor(node) {
  if (node.isDirectory) return 'text-blue-400'
  // ... color mapping by extension
}
```

**Extension Sets:**
- **Images:** `.png`, `.jpg`, `.jpeg`, `.gif`, `.svg`, `.webp` â†’ green
- **Videos:** `.mp4`, `.webm` â†’ purple
- **Code:** `.js`, `.ts`, `.vue`, `.py`, `.go`, `.rs`, etc. â†’ yellow
- **Text:** `.md`, `.txt`, `.json`, `.yaml`, etc. â†’ muted

---

### Q8: What is VMonacoEditor.vue?

**Location:** `/var/www/vibe-marketing/dashboard/components/VMonacoEditor.vue` (103 lines)

**Pattern:** Monaco Editor wrapper using `@guolao/vue-monaco-editor` CDN loader

**Props:**
```typescript
props: {
  value: string                    // Editor content
  language: string                 // 'markdown', 'typescript', 'json', etc.
  theme: string                    // 'vs-dark', 'vs-light'
  options: Record<string, any>     // Monaco editor options
}
```

**Emit:**
```typescript
emit('change', value: string)  // Content changed
```

**Loading Strategy:**
```typescript
onMounted(async () => {
  // Load Monaco from CDN (avoids Vite/Rollup worker bundling issues)
  const monaco = await loader.init()

  editorInstance.value = monaco.editor.create(containerRef.value, {
    value: props.value,
    language: props.language,
    theme: props.theme,
    ...props.options,
  })

  editorInstance.value.onDidChangeModelContent(() => {
    emit('change', editorInstance.value.getValue())
  })
})
```

**Fallback:**
If Monaco fails to load:
```vue
<textarea
  :value="value"
  class="w-full h-full bg-[#1e1e1e] text-[#d4d4d4] font-mono"
  @input="emit('change', $event.target.value)"
/>
```

**Watchers:**
- `watch(props.value)` â†’ Sync external changes to editor
- `watch(props.language)` â†’ Update syntax highlighting
- `watch(props.theme)` â†’ Update theme

**Usage in ArtifactsBrowser:**
```vue
<VMonacoEditor
  :value="fileContent"
  :language="selectedFileLanguage"  // computed from file extension
  theme="vs-dark"
  :options="{
    minimap: { enabled: false },
    fontSize: 13,
    lineNumbers: 'on',
    wordWrap: 'on',
    readOnly: false,
    tabSize: 2,
  }"
  @change="onEditorChange"
/>
```

---

## Architecture Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  default.vue Layout                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Sidebar   â”‚  â”‚  Topbar                             â”‚   â”‚
â”‚  â”‚            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  Nav Links â”‚  â”‚  â”‚Breadcrumbâ”‚  â”‚[FolderOpen]  â”‚    â”‚   â”‚
â”‚  â”‚            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                       â”‚             â”‚   â”‚
â”‚                  â”‚                       â””â”€â”€â”€â”€ onClick â”‚   â”‚
â”‚                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚                  â”‚  â”‚  <slot /> (page content)      â”‚  â”‚   â”‚
â”‚                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  <ArtifactsBrowser /> (hidden until opened)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ openArtifacts()
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ArtifactsBrowser Modal (Teleport to body)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  File Tree     â”‚  File Viewer                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ğŸ“projectsâ”‚  â”‚  â”‚  VMonacoEditor                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ“gym   â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    ğŸ“„x.mdâ”‚â—„â”€â”¼â”€â”€â”¼â”€â–ºâ”‚ # Campaign Brief       â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ“art   â”‚  â”‚  â”‚  â”‚                        â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ğŸ“.claude â”‚  â”‚  â”‚  â”‚ Content here...        â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â”‚
â”‚  â”‚                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â–²                             â”‚                      â”‚
â”‚         â”‚ fetchDirectory              â”‚ selectFile           â”‚
â”‚         â”‚ toggleDirectory             â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
          â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server API (Nuxt H3 handlers)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  GET /api/files?path=/projects/gym                   â”‚   â”‚
â”‚  â”‚  â†’ sanitizePath() â†’ readdir() â†’ filter/sort         â”‚   â”‚
â”‚  â”‚  â†’ { entries: [{ name, isDirectory, path, ... }] }  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  GET /api/file-content?path=/projects/gym/x.md      â”‚   â”‚
â”‚  â”‚  â†’ sanitizePath() â†’ isAllowedPath()                 â”‚   â”‚
â”‚  â”‚  â†’ readFile(path, 'utf-8')                          â”‚   â”‚
â”‚  â”‚  â†’ { content: "...", mimeType, size, modified }     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  POST /api/file-content                             â”‚   â”‚
â”‚  â”‚  body: { path, content }                            â”‚   â”‚
â”‚  â”‚  â†’ writeFile(path, content)                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  GET /api/file-serve?path=/image.png               â”‚   â”‚
â”‚  â”‚  â†’ readFile(path) as binary                         â”‚   â”‚
â”‚  â”‚  â†’ Content-Type: image/png                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Filesystem (sandboxed to /var/www/vibe-marketing)          â”‚
â”‚  /var/www/vibe-marketing/                                   â”‚
â”‚    projects/                                                â”‚
â”‚      gymzilla/                                              â”‚
â”‚        campaigns/                                           â”‚
â”‚          promo/                                             â”‚
â”‚            brief.md                                         â”‚
â”‚            draft.md                                         â”‚
â”‚        memory/                                              â”‚
â”‚    artifacts/                                               â”‚
â”‚    .claude/                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Files

| File | Purpose | Entry Points | Lines |
|------|---------|--------------|-------|
| `dashboard/components/ArtifactsBrowser.vue` | Main modal UI | `<ArtifactsBrowser />` in default.vue | 525 |
| `dashboard/composables/useArtifactsBrowser.ts` | Shared state | `useArtifactsBrowser()` | 25 |
| `dashboard/components/TreeNodeItem.vue` | Recursive tree node | Rendered by ArtifactsBrowser | 122 |
| `dashboard/components/VMonacoEditor.vue` | Monaco wrapper | Used by ArtifactsBrowser for text files | 103 |
| `dashboard/layouts/default.vue` | App layout | Wraps all pages | 165 |
| `dashboard/server/api/files.get.ts` | List directory | `GET /api/files?path=...` | 78 |
| `dashboard/server/api/file-content.get.ts` | Read text file | `GET /api/file-content?path=...` | 83 |
| `dashboard/server/api/file-content.post.ts` | Save text file | `POST /api/file-content` | 75 |
| `dashboard/server/api/file-serve.get.ts` | Serve binary files | `GET /api/file-serve?path=...` | 82 |
| `dashboard/server/utils/pathSanitizer.ts` | Security layer | Used by all API handlers | 38 |

---

## Data Flow Diagrams

### Opening Artifacts Browser

```
User clicks FolderOpen button in topbar
  â†“
openArtifacts() called (from useArtifactsBrowser)
  â†“
isOpen.value = true
  â†“
ArtifactsBrowser watch(isOpen) triggers
  â†“
loadRootTree() called
  â†“
fetchDirectory('/') â†’ GET /api/files?path=/
  â†“
Server: sanitizePath('/') â†’ /var/www/vibe-marketing/projects
  â†“
readdir('/var/www/vibe-marketing/projects')
  â†“
Returns: { entries: [{ name: 'gymzilla', isDirectory: true, ... }] }
  â†“
treeRoots.value = entries.map(e => ({ ...e, expanded: false, children: undefined }))
  â†“
Modal appears with root-level folders
```

### Expanding a Directory

```
User clicks "gymzilla" folder
  â†“
TreeNodeItem emits 'toggle' event
  â†“
ArtifactsBrowser toggleDirectory(node)
  â†“
node.loading = true
  â†“
fetchDirectory('/projects/gymzilla')
  â†“
GET /api/files?path=/projects/gymzilla
  â†“
Server: readdir('/var/www/vibe-marketing/projects/gymzilla')
  â†“
Returns: { entries: [{ name: 'campaigns', isDirectory: true, ... }] }
  â†“
node.children = entries
node.expanded = true
node.loading = false
  â†“
TreeNodeItem renders children recursively
```

### Selecting and Editing a File

```
User clicks "brief.md"
  â†“
TreeNodeItem emits 'select' event
  â†“
ArtifactsBrowser selectFile(entry)
  â†“
selectedFile.value = entry
fileDirty.value = false
  â†“
getFileType(entry.name) â†’ 'text'
  â†“
GET /api/file-content?path=/projects/gymzilla/campaigns/promo/brief.md
  â†“
Server: readFile('/var/www/vibe-marketing/projects/gymzilla/campaigns/promo/brief.md', 'utf-8')
  â†“
Returns: { content: "# Campaign Brief\n...", mimeType: "text/markdown", ... }
  â†“
fileContent.value = content
  â†“
VMonacoEditor renders with language="markdown"
  â†“
User edits content
  â†“
VMonacoEditor emits 'change' event
  â†“
onEditorChange(newValue)
  â†“
fileContent.value = newValue
fileDirty.value = true  (Save button turns blue)
  â†“
User presses Ctrl+S or clicks Save
  â†“
saveFile() called
  â†“
POST /api/file-content
body: { path: '/projects/gymzilla/campaigns/promo/brief.md', content: fileContent.value }
  â†“
Server: writeFile('/var/www/vibe-marketing/projects/gymzilla/campaigns/promo/brief.md', content, 'utf-8')
  â†“
Returns: { success: true }
  â†“
fileDirty.value = false  (Save button grays out)
```

---

## Security Model

### Path Traversal Protection

**Allowed Base:** `/var/www/vibe-marketing`

**Default Root:** `/var/www/vibe-marketing/projects`

**Sanitization Examples:**

| User Input | Sanitized Path |
|------------|----------------|
| `/` | `/var/www/vibe-marketing/projects` |
| `/projects` | `/var/www/vibe-marketing/projects` |
| `/projects/gymzilla` | `/var/www/vibe-marketing/projects/gymzilla` |
| `/artifacts/foo.png` | `/var/www/vibe-marketing/artifacts/foo.png` |
| `/../etc/passwd` | `/var/www/vibe-marketing/projects` (blocked) |
| `/projects/../../etc` | `/var/www/vibe-marketing/projects` (blocked) |
| `\0malicious` | Rejected (null byte check) |

**Allowed Directories:**
- `/var/www/vibe-marketing/projects/*` (default)
- `/var/www/vibe-marketing/artifacts/*`
- `/var/www/vibe-marketing/.claude/*`
- `/var/www/vibe-marketing/memory/*`
- Any other directory under `/var/www/vibe-marketing`

**Forbidden:**
- `/etc/*`
- `/root/*`
- `/home/*` (except via the allowed base)
- Anything outside `/var/www/vibe-marketing`

### File Type Restrictions

**Readable Text Files (30+ types):**
`.md`, `.txt`, `.json`, `.yaml`, `.yml`, `.html`, `.css`, `.js`, `.ts`, `.vue`, `.jsx`, `.tsx`, `.xml`, `.csv`, `.toml`, `.ini`, `.cfg`, `.conf`, `.sh`, `.bash`, `.py`, `.rb`, `.go`, `.rs`, `.java`, `.c`, `.cpp`, `.h`, `.env`, `.gitignore`, `.dockerfile`, `.sql`

**Writable Files:**
Same as readable, minus `.env`, `.gitignore`, `.dockerfile`

**Servable Binary Files:**
`.png`, `.jpg`, `.jpeg`, `.gif`, `.svg`, `.webp`, `.ico`, `.mp4`, `.webm`, `.pdf`, `.zip`, `.tar`, `.gz`

**Create New Files:** Not supported - POST only updates existing files

---

## Conventions Discovered

### Naming
- **Components:** PascalCase (`ArtifactsBrowser`, `TreeNodeItem`, `VMonacoEditor`)
- **Composables:** camelCase with `use` prefix (`useArtifactsBrowser`, `useCurrentProject`)
- **API Handlers:** `[name].[method].ts` (`files.get.ts`, `file-content.post.ts`)
- **Utils:** camelCase (`pathSanitizer.ts`)

### File Organization
```
dashboard/
  components/          # Vue components (shared)
    ArtifactsBrowser.vue
    TreeNodeItem.vue
    VMonacoEditor.vue
  composables/         # Shared state/logic
    useArtifactsBrowser.ts
    useCurrentProject.ts
  layouts/             # App layouts (wrap pages)
    default.vue
  pages/               # File-based routing
    index.vue          # /
    agents.vue         # /agents
    projects/
      [slug].vue       # /projects/:slug (layout wrapper)
        index.vue      # /projects/:slug/ (nested page)
  server/
    api/               # API endpoints (H3 handlers)
      files.get.ts
      file-content.get.ts
      file-content.post.ts
      file-serve.get.ts
    utils/             # Server-only utilities
      pathSanitizer.ts
```

### Testing
- Test files: `dashboard/tests/unit/*.spec.ts`
- Pattern: `[name].spec.ts` (e.g., `ArtifactsBrowser.spec.ts`, `pathSanitizer.spec.ts`)
- Framework: Vitest (inferred from Nuxt defaults)

### Patterns
| Pattern | Usage | Example |
|---------|-------|---------|
| Module-level singleton | Shared state in composables | `useArtifactsBrowser()` |
| Recursive components | Tree rendering | `TreeNodeItem` |
| API route handlers | Server endpoints | `files.get.ts` |
| Path sanitization | Security layer | `pathSanitizer.ts` |
| File-based routing | Nuxt pages | `pages/projects/[slug].vue` |
| Teleport modals | Full-screen overlays | `<Teleport to="body">` |
| ClientOnly wrapping | SSR-incompatible libs | `<ClientOnly><VMonacoEditor /></ClientOnly>` |

---

## Open Questions

1. **Convex integration:** How does `useConvexQuery` work? (Not explored - out of scope)
2. **Auth middleware:** Is there authentication on API routes? (Not seen in code)
3. **File creation:** Will there be a "New File" button in the future? (POST endpoint blocks creation)
4. **Project-scoped artifacts:** Should artifacts browser filter by project slug when on project pages?
5. **Permissions:** Can different users have different file access levels? (Currently no user-based filtering)
6. **Real-time updates:** If another session edits a file, does the tree/viewer refresh? (No WebSocket/polling detected)
7. **Large files:** Is there a size limit on editable files? (No limit seen in code - potential issue)
8. **Binary editing:** Will there be support for editing images, videos, etc.? (Currently read-only for binaries)

---

## Implementation Notes

### Monaco Editor Loading
Uses CDN loading via `@guolao/vue-monaco-editor` to avoid Vite worker bundling issues:
```typescript
const monaco = await loader.init()  // Loads from CDN
```

### Lazy Tree Loading
Directories don't load children until expanded:
```typescript
interface TreeNode {
  children?: TreeNode[]  // undefined = not loaded yet
  expanded?: boolean     // false = collapsed, true = expanded
  loading?: boolean      // true = fetching children
}
```

### Dirty State Management
Save button state driven by `fileDirty` flag:
```typescript
onEditorChange(newValue) {
  fileContent.value = newValue
  fileDirty.value = true  // Enables save button
}

saveFile() {
  // ... POST to API
  fileDirty.value = false  // Disables save button
}
```

### Unsaved Changes Warning
Prompts user before switching files:
```typescript
async function selectFile(entry: FileEntry) {
  if (fileDirty.value && selectedFile.value) {
    const discard = confirm('You have unsaved changes. Discard them?')
    if (!discard) return
  }
  // ... proceed with loading new file
}
```

### Keyboard Shortcuts
- `Escape` â†’ Close modal
- `Ctrl/Cmd+S` â†’ Save file (if dirty)

### Path Handling
All paths stored relative to `/var/www/vibe-marketing`:
```typescript
// API returns:
{ path: '/projects/gymzilla/brief.md' }

// Server resolves to:
'/var/www/vibe-marketing/projects/gymzilla/brief.md'
```

---

## Test Coverage

Found test files (âœ“ VERIFIED):
- `dashboard/tests/unit/ArtifactsBrowser.spec.ts` (exists)
- `dashboard/tests/unit/useArtifactsBrowser.spec.ts` (exists)
- `dashboard/tests/unit/pathSanitizer.spec.ts` (exists)

Test data attributes in components:
```vue
<div data-testid="artifacts-browser">
<button data-testid="close-button">
<button data-testid="save-button">
<div data-testid="file-tree-panel">
<div data-testid="file-viewer-panel">
```

---

## Dependencies

**Monaco Editor:**
- `@guolao/vue-monaco-editor` - Vue 3 wrapper
- Loads Monaco from CDN (not bundled)

**Icons:**
- `lucide-vue-next` - Icon components (FolderOpen, File, Save, etc.)

**Framework:**
- Nuxt 3 (file-based routing, layouts, server API)
- Vue 3 (composition API, Teleport, ClientOnly)
- H3 (server handlers)

**Node APIs:**
- `fs/promises` (readdir, readFile, writeFile, stat)
- `path` (resolve, join, extname)

---

## Performance Considerations

1. **Lazy Loading:** Only fetches directory contents when expanded (saves bandwidth)
2. **No Recursive Loading:** Doesn't preload entire tree (avoids thousands of files)
3. **Binary Streaming:** Large images/videos served via `/api/file-serve` with caching headers
4. **Monaco CDN:** Editor loads from CDN (cached across sites)
5. **Minimal Watchers:** Only watches `isOpen`, `value`, `language`, `theme` (not deep)

**Potential Bottlenecks:**
- Large text files (no pagination in editor)
- Deep directory trees (recursive component rendering)
- No virtualization (renders all visible tree nodes)

---

## End of Report

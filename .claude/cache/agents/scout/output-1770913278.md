# Codebase Report: Skills Architecture Exploration
Generated: 2026-02-12 15:45:00

## Summary

The vibe-marketing platform has a comprehensive skills system for managing marketing copywriting frameworks. Skills are organized into layers (L1-L5), stored in Convex, and selected during campaign creation. The current implementation uses a 3-field skillConfig structure in campaigns:
- `offerFramework` (L2, single selection)
- `persuasionSkills` (L3, multi-select with sub-selections)
- `primaryCopyStyle` (L4, single selection)

## 1. Skills Table Schema

**Location:** `/var/www/vibe-marketing/convex/schema.ts` (lines 495-521)

```typescript
skills: defineTable({
  name: v.string(),                    // e.g., "mbook-schwarz-awareness"
  slug: v.string(),                    // unique identifier
  displayName: v.string(),             // e.g., "Schwartz Awareness Levels"
  description: v.string(),             // Full description
  category: v.string(),                // e.g., "L1_audience", "L2_offer", "L3_persuasion", "L4_craft"
  type: v.union(                       // Skill type
    v.literal("mbook"),                // Marketing book-derived
    v.literal("procedure"),            // Procedural skill
    v.literal("community"),            // Community-contributed
    v.literal("custom")                // Custom skill
  ),
  isAutoActive: v.boolean(),           // Auto-applied to all campaigns (L1 only)
  isCampaignSelectable: v.boolean(),   // Can be selected in campaign UI
  subSelections: v.optional(           // Sub-options within a skill
    v.array(v.object({
      key: v.string(),                 // e.g., "reciprocity", "scarcity"
      label: v.string(),               // Display name
      description: v.optional(v.string())
    }))
  ),
  categoryConstraints: v.optional(     // Selection rules (UNUSED currently)
    v.object({
      maxPerCampaign: v.optional(v.number()),
      selectionMode: v.optional(v.string())
    })
  ),
  filePath: v.string(),                // Path to SKILL.md file
  fileHash: v.optional(v.string()),    // For sync detection
  tagline: v.optional(v.string()),     // Short tagline
  dashboardDescription: v.optional(v.string()), // Dashboard-specific description
  lastSyncedAt: v.number(),            // Last sync timestamp
  syncStatus: v.union(                 // Sync status
    v.literal("synced"),
    v.literal("file_missing"),
    v.literal("pending_sync"),
    v.literal("pending_setup")
  ),
})
.index("by_slug", ["slug"])
.index("by_category", ["category"])
.index("by_type", ["type"])
.index("by_selectable", ["isCampaignSelectable"])
```

### Key Fields

| Field | Purpose | Examples |
|-------|---------|----------|
| `category` | Layer grouping | `L1_audience`, `L2_offer`, `L3_persuasion`, `L4_craft` |
| `isAutoActive` | Auto-applied? | `true` for L1 (Schwartz), `false` for others |
| `isCampaignSelectable` | Show in UI? | `false` for L1, `true` for L2-L4 |
| `subSelections` | Sub-options | Cialdini principles, Sugarman triggers |

## 2. Skills Functions

**Location:** `/var/www/vibe-marketing/convex/skills.ts`

### Queries

```typescript
// Get all skills
list: query({
  args: {},
  handler: async (ctx) => await ctx.db.query("skills").collect()
})

// Get single skill by ID
get: query({
  args: { id: v.id("skills") },
  handler: async (ctx, args) => await ctx.db.get(args.id)
})

// Get skill by slug
getBySlug: query({
  args: { slug: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("skills")
      .withIndex("by_slug", (q) => q.eq("slug", args.slug))
      .first()
  }
})

// Get skills by category (e.g., "L2_offer")
listByCategory: query({
  args: { category: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("skills")
      .withIndex("by_category", (q) => q.eq("category", args.category))
      .collect()
  }
})

// Get campaign-selectable skills only
listCampaignSelectable: query({
  args: {},
  handler: async (ctx) => {
    const all = await ctx.db.query("skills").collect()
    return all.filter((s) => s.isCampaignSelectable)
  }
})

// Get skills grouped by category (sorted by sortOrder)
listGroupedByCategory: query({
  args: {},
  handler: async (ctx) => {
    const skills = await ctx.db.query("skills").collect()
    const categories = await ctx.db.query("skillCategories").collect()
    categories.sort((a, b) => a.sortOrder - b.sortOrder)
    
    // Groups skills by category, returns:
    // [{ category: CategoryObj, skills: Skill[] }, ...]
  }
})
```

### Mutations

```typescript
// Update skill metadata
update: mutation({
  args: {
    id: v.id("skills"),
    displayName: v.optional(v.string()),
    description: v.optional(v.string()),
    category: v.optional(v.string()),
    type: v.optional(...),
    isAutoActive: v.optional(v.boolean()),
    isCampaignSelectable: v.optional(v.boolean()),
    tagline: v.optional(v.string()),
    dashboardDescription: v.optional(v.string()),
    subSelections: v.optional(...)
  },
  handler: async (ctx, { id, ...fields }) => {
    await ctx.db.patch(id, fields)
  }
})

// Delete skill
remove: mutation({
  args: { id: v.id("skills") },
  handler: async (ctx, args) => {
    await ctx.db.delete(args.id)
  }
})

// Mark skill as file_missing
markMissing: mutation({
  args: { id: v.id("skills") },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.id, { syncStatus: "file_missing" })
  }
})

// Create or update skill by slug (used by seed script)
upsertBySlug: mutation({
  args: {
    slug: v.string(),
    name: v.string(),
    displayName: v.string(),
    description: v.string(),
    category: v.string(),
    type: v.union(...),
    isAutoActive: v.boolean(),
    isCampaignSelectable: v.boolean(),
    subSelections: v.optional(...),
    filePath: v.string(),
    fileHash: v.optional(v.string()),
    tagline: v.optional(v.string()),
    dashboardDescription: v.optional(v.string())
  },
  handler: async (ctx, args) => {
    const existing = await ctx.db
      .query("skills")
      .withIndex("by_slug", (q) => q.eq("slug", args.slug))
      .first()
    
    if (existing) {
      await ctx.db.patch(existing._id, { ...args, lastSyncedAt: Date.now(), syncStatus: "synced" })
      return existing._id
    } else {
      return await ctx.db.insert("skills", { ...args, lastSyncedAt: Date.now(), syncStatus: "synced" })
    }
  }
})
```

## 3. Skill Categories Table

**Location:** `/var/www/vibe-marketing/convex/schema.ts` (lines 523-537)

```typescript
skillCategories: defineTable({
  key: v.string(),                     // e.g., "L2_offer", "L3_persuasion"
  displayName: v.string(),             // e.g., "L2: Offer Framework"
  description: v.string(),             // Category description
  sortOrder: v.number(),               // Display order
  scope: v.union(                      // Category scope
    v.literal("copy"),
    v.literal("research"),
    v.literal("visual"),
    v.literal("quality"),
    v.literal("general")
  ),
  maxPerPipelineStep: v.optional(v.number()),     // UNUSED
  selectionMode: v.optional(v.string())           // UNUSED
})
.index("by_key", ["key"])
.index("by_scope", ["scope"])
```

### Skill Categories Functions

**Location:** `/var/www/vibe-marketing/convex/skillCategories.ts`

```typescript
// List all categories (sorted by sortOrder)
list: query({
  args: {},
  handler: async (ctx) => {
    const cats = await ctx.db.query("skillCategories").collect()
    return cats.sort((a, b) => a.sortOrder - b.sortOrder)
  }
})

// Create or update category
upsert: mutation({
  args: {
    key: v.string(),
    displayName: v.string(),
    description: v.string(),
    sortOrder: v.number(),
    scope: v.union(...),
    maxPerPipelineStep: v.optional(v.number()),
    selectionMode: v.optional(v.string())
  },
  handler: async (ctx, args) => {
    const existing = await ctx.db
      .query("skillCategories")
      .withIndex("by_key", (q) => q.eq("key", args.key))
      .first()
    
    if (existing) {
      await ctx.db.patch(existing._id, args)
      return existing._id
    } else {
      return await ctx.db.insert("skillCategories", args)
    }
  }
})
```

## 4. Seed Script

**Location:** `/var/www/vibe-marketing/scripts/seed-skills.sh`

Seeds 11 marketing book skills using `npx convex run skills:upsertBySlug`:

### Skills Seeded

| Skill | Category | Auto? | Selectable? | Sub-selections |
|-------|----------|-------|-------------|----------------|
| `mbook-schwarz-awareness` | L1_audience | ✓ | ✗ | None |
| `mbook-hormozi-offers` | L2_offer | ✗ | ✓ | None |
| `mbook-hormozi-leads` | L2_offer | ✗ | ✓ | None |
| `mbook-brunson-dotcom` | L2_offer | ✗ | ✓ | None |
| `mbook-brunson-expert` | L2_offer | ✗ | ✓ | None |
| `mbook-cialdini-influence` | L3_persuasion | ✗ | ✓ | 7 principles |
| `mbook-voss-negotiation` | L3_persuasion | ✗ | ✓ | None |
| `mbook-miller-storybrand` | L3_persuasion | ✗ | ✓ | None |
| `mbook-sugarman-copywriting` | L3_persuasion | ✗ | ✓ | 5 triggers |
| `mbook-halbert-boron` | L4_craft | ✗ | ✓ | None |
| `mbook-ogilvy-advertising` | L4_craft | ✗ | ✓ | None |

### Example: Cialdini with Sub-selections

```bash
run '{
  "slug": "mbook-cialdini-influence",
  "name": "mbook-cialdini-influence",
  "displayName": "Cialdini Influence Principles",
  "description": "Apply the 7 principles of persuasion...",
  "category": "L3_persuasion",
  "type": "mbook",
  "isAutoActive": false,
  "isCampaignSelectable": true,
  "subSelections": [
    {"key": "reciprocity", "label": "Reciprocity", "description": "Give value first..."},
    {"key": "liking", "label": "Liking", "description": "Build rapport..."},
    {"key": "social_proof", "label": "Social Proof", "description": "Show others..."},
    {"key": "authority", "label": "Authority", "description": "Establish expertise..."},
    {"key": "scarcity", "label": "Scarcity", "description": "Limited availability..."},
    {"key": "commitment", "label": "Commitment/Consistency", "description": "Small yeses..."},
    {"key": "unity", "label": "Unity", "description": "Shared identity..."}
  ],
  "filePath": ".claude/skills/mbook-cialdini-influence/SKILL.md",
  "tagline": "The science of ethical persuasion",
  "dashboardDescription": "7 persuasion principles with sub-selections..."
}'
```

## 5. Campaign Schema - skillConfig Field

**Location:** `/var/www/vibe-marketing/convex/schema.ts` (lines 413-432)

```typescript
campaigns: defineTable({
  // ... other fields ...
  skillConfig: v.optional(v.object({
    offerFramework: v.optional(v.object({
      skillId: v.id("skills")
    })),
    persuasionSkills: v.optional(v.array(v.object({
      skillId: v.id("skills"),
      subSelections: v.optional(v.array(v.string()))  // Array of subSelection keys
    }))),
    primaryCopyStyle: v.optional(v.object({
      skillId: v.id("skills")
    })),
    secondaryCopyStyle: v.optional(v.object({         // DEFINED but UNUSED
      skillId: v.id("skills")
    })),
    agentOverrides: v.optional(v.array(v.object({     // DEFINED but UNUSED
      agentName: v.string(),
      pipelineStep: v.number(),
      skillOverrides: v.array(v.object({
        skillId: v.id("skills"),
        subSelections: v.optional(v.array(v.string()))
      }))
    }))),
    summary: v.optional(v.string())                   // DEFINED but UNUSED
  }))
  // ... other fields ...
})
```

### Current Usage

**Used Fields:**
- `offerFramework` - Single L2 skill (radio selection)
- `persuasionSkills` - Array of L3 skills with sub-selections (checkboxes)
- `primaryCopyStyle` - Single L4 skill (radio selection)

**Unused Fields:**
- `secondaryCopyStyle` - Defined in schema, not in UI
- `agentOverrides` - Defined in schema, not in UI
- `summary` - Defined in schema, not in UI

## 6. Campaign Form UI

**Location:** `/var/www/vibe-marketing/dashboard/components/CampaignForm.vue`

### Form State (lines 42-68)

```typescript
const form = reactive({
  // ... other fields ...
  skillConfig: {
    offerFramework: null as { skillId: string } | null,
    persuasionSkills: [] as SkillSelection[],
    primaryCopyStyle: null as { skillId: string } | null,
    agentOverrides: [] as AgentOverride[],  // Empty array, not used
  }
})
```

### Layer Configuration (lines 114-119)

```typescript
const layerLabels: Record<string, string> = {
  L2_offer: 'L2: Offer Framework',
  L3_persuasion: 'L3: Persuasion & Narrative',
  L4_craft: 'L4: Copy Style',
}

const layerOrder = ['L2_offer', 'L3_persuasion', 'L4_craft']
```

### Skill Selection Logic

**L2 - Offer Framework (lines 258-261, 636-676)**
- Radio selection (pick one or none)
- "None" option available
- Stored as: `{ skillId: string } | null`

```typescript
function selectOfferFramework(skillId: string | null) {
  form.skillConfig.offerFramework = skillId ? { skillId } : null
}
```

**L3 - Persuasion Skills (lines 263-290, 679-729)**
- Checkbox multi-select
- Sub-selections displayed as nested checkboxes
- Stored as: `Array<{ skillId: string, subSelections?: string[] }>`

```typescript
function togglePersuasionSkill(skillId: string) {
  const idx = form.skillConfig.persuasionSkills.findIndex(s => s.skillId === skillId)
  if (idx >= 0) {
    form.skillConfig.persuasionSkills.splice(idx, 1)
  } else {
    form.skillConfig.persuasionSkills.push({ skillId })
  }
}

function togglePersuasionSubSelection(skillId: string, subKey: string) {
  const sel = form.skillConfig.persuasionSkills.find(s => s.skillId === skillId)
  if (!sel) return
  if (!sel.subSelections) sel.subSelections = []
  const idx = sel.subSelections.indexOf(subKey)
  if (idx >= 0) {
    sel.subSelections.splice(idx, 1)
  } else {
    sel.subSelections.push(subKey)
  }
}
```

**L4 - Copy Style (lines 291-294, 732-776)**
- Radio selection (pick one or none)
- "Auto-select based on content" option available
- Stored as: `{ skillId: string } | null`

```typescript
function selectPrimaryCopyStyle(skillId: string | null) {
  form.skillConfig.primaryCopyStyle = skillId ? { skillId } : null
}
```

### Summary Generation (lines 311-327)

```typescript
const writingStrategySummary = computed(() => {
  const parts: string[] = []
  if (form.skillConfig.offerFramework) {
    const s = getSkillById(form.skillConfig.offerFramework.skillId)
    if (s) parts.push(`L2: ${s.displayName}`)
  }
  for (const ps of form.skillConfig.persuasionSkills) {
    const s = getSkillById(ps.skillId)
    const subs = ps.subSelections?.length ? ` [${ps.subSelections.join(', ')}]` : ''
    if (s) parts.push(`L3: ${s.displayName}${subs}`)
  }
  if (form.skillConfig.primaryCopyStyle) {
    const s = getSkillById(form.skillConfig.primaryCopyStyle.skillId)
    if (s) parts.push(`L4: ${s.displayName}`)
  }
  return parts.join(' + ') || 'None selected'
})
```

## 7. Campaign Detail Page Display

**Location:** `/var/www/vibe-marketing/dashboard/pages/projects/[slug]/campaigns/[id].vue`

### Writing Strategy Summary (lines 37-58)

```typescript
const writingStrategySummary = computed(() => {
  const sc = campaign.value?.skillConfig
  if (!sc) return null
  const items: { layer: string; name: string; subs?: string[] }[] = []
  
  if (sc.offerFramework?.skillId) {
    const s = skillMap.value[sc.offerFramework.skillId]
    if (s) items.push({ layer: 'L2', name: s.displayName })
  }
  
  if (sc.persuasionSkills?.length) {
    for (const ps of sc.persuasionSkills) {
      const s = skillMap.value[ps.skillId]
      if (s) items.push({ layer: 'L3', name: s.displayName, subs: ps.subSelections })
    }
  }
  
  if (sc.primaryCopyStyle?.skillId) {
    const s = skillMap.value[sc.primaryCopyStyle.skillId]
    if (s) items.push({ layer: 'L4', name: s.displayName })
  }
  
  return items.length > 0 ? items : null
})
```

### Display Template (lines 161-177)

```vue
<div v-if="writingStrategySummary" class="mb-6">
  <div class="rounded-lg border bg-card shadow-sm p-4">
    <h3 class="text-sm font-medium text-foreground mb-3">Writing Strategy</h3>
    <div class="flex flex-wrap gap-2 mb-2">
      <!-- L1: Auto-active (always shown) -->
      <span class="inline-flex items-center gap-1 bg-blue-50 text-blue-700 text-xs px-2.5 py-1 rounded-full font-medium">
        L1: Schwartz Awareness
        <span class="text-blue-400 font-normal">(auto)</span>
      </span>
      
      <!-- L2-L4: Selected skills -->
      <span v-for="item in writingStrategySummary" :key="item.name"
        class="inline-flex items-center gap-1 bg-primary/10 text-primary text-xs px-2.5 py-1 rounded-full font-medium">
        {{ item.layer }}: {{ item.name }}
        <template v-if="item.subs?.length">
          <span class="text-primary/60 font-normal">[{{ item.subs.join(', ') }}]</span>
        </template>
      </span>
      
      <!-- L5: Quality (auto-active, always shown) -->
      <span class="inline-flex items-center gap-1 bg-blue-50 text-blue-700 text-xs px-2.5 py-1 rounded-full font-medium">
        L5: Quality
        <span class="text-blue-400 font-normal">(auto)</span>
      </span>
    </div>
  </div>
</div>
```

## Key Findings

### Current Architecture

1. **Layer Model**: L1 (auto) → L2 (radio) → L3 (multi-checkbox) → L4 (radio) → L5 (auto)
2. **Storage**: 3-field structure in `campaigns.skillConfig`
3. **Selection UI**: Step 4 of 5-step campaign wizard
4. **Display**: Badge-style pills showing layer + skill name + sub-selections

### Observations

1. **L1 & L5 are hardcoded** - Schwartz Awareness (L1) and Quality (L5) are always shown as auto-active
2. **Sub-selections only for L3** - Only persuasion skills (Cialdini, Sugarman) have sub-selections
3. **Unused schema fields** - `secondaryCopyStyle`, `agentOverrides`, `summary` are defined but not used
4. **No L5 skills in DB** - L5 "Quality" layer is mentioned in UI but has no skills table entries
5. **Category constraints unused** - `categoryConstraints` field exists but UI doesn't enforce `maxPerCampaign` or `selectionMode`

### Data Flow

```
Seed Script → skills:upsertBySlug → skills table
                                         ↓
Campaign Form → skills:list → Group by category → UI display
                                         ↓
User selects skills → form.skillConfig → campaigns:create/update
                                         ↓
Campaign Detail → campaigns:get + skills:list → Display badges
```

## Questions Answered

### Q1: What is the exact `skills` table schema?
✓ **Answered** - See section 1 above. 13 fields total, indexed by slug/category/type/selectable.

### Q2: What functions exist in `convex/skills.ts`?
✓ **Answered** - See section 2 above. 7 queries (list, get, getBySlug, listByCategory, listCampaignSelectable, listGroupedByCategory, upsertBySlug) + 3 mutations (update, remove, markMissing).

### Q3: What does `convex/skillCategories.ts` do?
✓ **Answered** - See section 3 above. Manages skill categories with 1 query (list) and 1 mutation (upsert).

### Q4: What skills are seeded?
✓ **Answered** - See section 4 above. 11 skills: 1 L1 (auto), 4 L2, 4 L3, 2 L4.

### Q5: What is the campaign `skillConfig` structure?
✓ **Answered** - See section 5 above. 3 used fields (offerFramework, persuasionSkills, primaryCopyStyle) + 3 unused fields (secondaryCopyStyle, agentOverrides, summary).

## Recommendations

1. **Add L5 skills to seed script** - Currently L5 "Quality" is hardcoded in UI but has no DB entries
2. **Remove unused schema fields** - Or implement `secondaryCopyStyle`, `agentOverrides`, `summary` if needed
3. **Enforce category constraints** - Use `maxPerCampaign` from `categoryConstraints` if needed
4. **Add skill categories seed** - No seed script for `skillCategories` table found
5. **Consider flexible skillConfig** - Current structure is rigid (3 named fields). Consider array-based approach for extensibility.


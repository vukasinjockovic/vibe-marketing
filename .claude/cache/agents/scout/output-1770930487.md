# Codebase Report: Agents & Skills Seeding Architecture
Generated: 2026-02-12

## Summary

The Vibe Marketing platform uses Convex as its database with a **direct many-to-many relationship** between agents and skills via arrays of skill IDs stored in the agents table. There is **NO junction table**. The seed architecture is split across **3 scripts**:

1. `/var/www/vibe-marketing/convex/seed.ts` - Seeds agents, pipelines, service categories, skill categories
2. `/var/www/vibe-marketing/scripts/seed-skills.sh` - Seeds 13 marketing book skills (mbook-*) + 2 quality skills
3. `/var/www/vibe-marketing/scripts/seed-skill-categories.sh` - Seeds 9 skill categories (older, simpler version)

## Schema Analysis

### Table: `agents`

**Location:** `/var/www/vibe-marketing/convex/schema.ts` (lines 542-560)

```typescript
agents: defineTable({
  name: v.string(),
  displayName: v.string(),
  role: v.string(),
  status: v.union(v.literal("idle"), v.literal("active"), v.literal("blocked"), v.literal("offline")),
  currentTaskId: v.optional(v.id("tasks")),
  lastHeartbeat: v.number(),
  heartbeatCron: v.string(),
  defaultModel: v.string(),
  skillPath: v.string(),
  level: v.union(v.literal("intern"), v.literal("specialist"), v.literal("lead"), v.literal("orchestrator")),
  stats: v.object({
    tasksCompleted: v.number(),
    avgQualityScore: v.optional(v.number()),
    lastActive: v.number(),
  }),
  staticSkillIds: v.array(v.id("skills")),  // ← Many-to-many via array
  dynamicSkillIds: v.array(v.id("skills")), // ← Many-to-many via array
  agentFilePath: v.string(),
}).index("by_name", ["name"])
  .index("by_status", ["status"])
```

**Indexes:**
- `by_name` - lookup agents by name
- `by_status` - filter agents by idle/active/blocked/offline

**Skill Relationship:**
- `staticSkillIds`: Array of skill IDs that are always available to the agent
- `dynamicSkillIds`: Array of skill IDs that can change based on context/campaign
- **NO junction table** - direct array reference to skills

### Table: `skills`

**Location:** `/var/www/vibe-marketing/convex/schema.ts` (lines 568-604)

```typescript
skills: defineTable({
  name: v.string(),
  slug: v.string(),
  displayName: v.string(),
  description: v.string(),
  category: v.string(),  // ← References skillCategories.key
  type: v.union(v.literal("mbook"), v.literal("procedure"), v.literal("community"), v.literal("custom")),
  isAutoActive: v.boolean(),
  isCampaignSelectable: v.boolean(),
  subSelections: v.optional(v.array(v.object({
    key: v.string(),
    label: v.string(),
    description: v.optional(v.string()),
  }))),
  categoryConstraints: v.optional(v.object({
    maxPerCampaign: v.optional(v.number()),
    selectionMode: v.optional(v.string()),
  })),
  filePath: v.string(),
  fileHash: v.optional(v.string()),
  tagline: v.optional(v.string()),
  dashboardDescription: v.optional(v.string()),
  lastSyncedAt: v.number(),
  syncStatus: v.union(
    v.literal("synced"),
    v.literal("file_missing"),
    v.literal("pending_sync"),
    v.literal("pending_setup")
  ),
}).index("by_slug", ["slug"])
  .index("by_category", ["category"])
  .index("by_type", ["type"])
  .index("by_selectable", ["isCampaignSelectable"])
```

**Indexes:**
- `by_slug` - unique lookup by slug (used in upsertBySlug)
- `by_category` - filter by category (L1_audience, L2_offer, etc.)
- `by_type` - filter by type (mbook, procedure, community, custom)
- `by_selectable` - filter campaign-selectable skills

**Key Fields:**
- `category` - string key referencing `skillCategories.key` (soft reference, not FK)
- `isAutoActive` - if true, always applied (e.g., Schwartz Awareness, Humanizer)
- `isCampaignSelectable` - if true, users can select in dashboard
- `subSelections` - for skills with sub-options (e.g., Cialdini's 7 principles)

### Table: `skillCategories`

**Location:** `/var/www/vibe-marketing/convex/schema.ts` (lines 606-627)

```typescript
skillCategories: defineTable({
  key: v.string(),  // ← Referenced by skills.category
  displayName: v.string(),
  description: v.string(),
  sortOrder: v.number(),
  scope: v.union(
    v.literal("copy"),
    v.literal("research"),
    v.literal("visual"),
    v.literal("quality"),
    v.literal("general")
  ),
  maxPerPipelineStep: v.optional(v.number()),
  selectionMode: v.optional(v.string()),  // "auto", "radio", "checkbox"
  pipelineAgentNames: v.optional(v.array(v.string())),
  allowNone: v.optional(v.boolean()),
}).index("by_key", ["key"])
  .index("by_scope", ["scope"])
```

**Indexes:**
- `by_key` - lookup by unique key (L1_audience, L2_offer, etc.)
- `by_scope` - filter by scope (copy, research, visual, quality, general)

**Key Fields:**
- `pipelineAgentNames` - array of agent names that use this category (e.g., ["vibe-content-writer", "vibe-email-writer"])
- `selectionMode` - how skills in this category are selected ("auto", "radio", "checkbox")
- `maxPerPipelineStep` - how many skills from this category can be used per step

### No Junction Table

There is **NO** `agentSkills` or similar junction table. The relationship is:
- **Agents → Skills**: Via `staticSkillIds` and `dynamicSkillIds` arrays in agents table
- **Skills → Categories**: Via `category` string field in skills table (soft reference)
- **Categories → Agents**: Via `pipelineAgentNames` array in skillCategories table (soft reference)

## Convex Functions

### `/var/www/vibe-marketing/convex/agents.ts`

**Key Functions:**
```typescript
export const list = query({})  // Get all agents
export const get = query({ id })  // Get by ID
export const getByName = query({ name })  // Get by name (indexed)
export const listActive = query({})  // Filter by status
export const register = mutation({  // Create new agent
  name, displayName, role, heartbeatCron, defaultModel, skillPath, level,
  agentFilePath, status?, staticSkillIds?, dynamicSkillIds?
})
export const updateSkills = mutation({  // Update agent's skills
  id: v.id("agents"),
  staticSkillIds?: v.array(v.id("skills")),
  dynamicSkillIds?: v.array(v.id("skills")),
})
export const listWithSkills = query({})  // Get agents with skill data
```

### `/var/www/vibe-marketing/convex/skills.ts`

**Key Functions:**
```typescript
export const list = query({})  // Get all skills
export const get = query({ id })  // Get by ID
export const getBySlug = query({ slug })  // Get by slug (indexed)
export const listByCategory = query({ category })  // Filter by category
export const listCampaignSelectable = query({})  // Filter selectable skills
export const listSelectableByCategories = query({ categoryKeys })  // Filter by category keys
export const upsertBySlug = mutation({  // Create or update skill by slug
  slug, name, displayName, description, category, type,
  isAutoActive, isCampaignSelectable, subSelections?,
  filePath, fileHash?, tagline?, dashboardDescription?
})
export const update = mutation({ id, ...fields })  // Patch skill fields
export const remove = mutation({ id })  // Delete skill
export const markMissing = mutation({ id })  // Mark file as missing
export const listGroupedByCategory = query({})  // Group skills by category
```

### `/var/www/vibe-marketing/convex/skillCategories.ts`

**Key Functions:**
```typescript
export const list = query({})  // Get all categories (sorted)
export const listForPipeline = query({ agentNames })  // Filter by agent names
export const upsert = mutation({  // Create or update category
  key, displayName, description, sortOrder, scope,
  maxPerPipelineStep?, selectionMode?, pipelineAgentNames?, allowNone?
})
```

## Seed Scripts Analysis

### 1. `/var/www/vibe-marketing/convex/seed.ts` (595 lines)

**What it seeds:**

#### Service Categories (21 categories)
- seo_keywords, serp_tracking, web_scraping, social_x, social_reddit, social_linkedin, social_meta, social_tiktok, social_youtube, image_generation, templated_images, video_generation, ai_presenter, email_sending, social_publishing, cms_publishing, content_quality, web_search, analytics, document_generation, notifications

#### Skill Categories (9 categories)
```typescript
{ key: "L1_audience", displayName: "L1: Audience Understanding", scope: "copy", selectionMode: "auto" }
{ key: "L2_offer", displayName: "L2: Offer Structure", scope: "copy", selectionMode: "radio" }
{ key: "L3_persuasion", displayName: "L3: Persuasion & Narrative", scope: "copy", selectionMode: "checkbox" }
{ key: "L4_craft", displayName: "L4: Copywriting Craft", scope: "copy", selectionMode: "radio" }
{ key: "L5_quality", displayName: "L5: Quality Assurance", scope: "quality", selectionMode: "auto" }
{ key: "research_method", displayName: "Research Methods", scope: "research" }
{ key: "content_format", displayName: "Content Formats", scope: "general" }
{ key: "visual_style", displayName: "Visual Style", scope: "visual" }
{ key: "agent_procedure", displayName: "Agent Procedures", scope: "general" }
```

#### Preset Pipelines (6 pipelines)
- research-only
- content-draft
- full-content-production
- launch-package
- audience-discovery
- document-import

#### Agents (18 agents)
All seeded with **empty skill arrays**:
```typescript
staticSkillIds: [] as any[],
dynamicSkillIds: [] as any[],
```

**Agent List:**
1. `vibe-audience-parser` - Parse uploaded audience documents
2. `vibe-audience-researcher` - Generate audience segments from scratch
3. `vibe-audience-enricher` - Add psychographics and language patterns
4. `vibe-keyword-researcher` - Keyword research and content briefs
5. `vibe-serp-analyzer` - SERP analysis and competition
6. `vibe-content-writer` - Long-form article writing
7. `vibe-content-reviewer` - Quality review for accuracy/SEO
8. `vibe-humanizer` - Remove AI writing patterns
9. `vibe-content-repurposer` - Repurpose content for different formats
10. `vibe-social-writer` - Social media posts
11. `vibe-email-writer` - Email sequences and newsletters
12. `vibe-ad-writer` - Ad copy (Google/Meta/LinkedIn)
13. `vibe-landing-page-writer` - Landing pages and sales pages
14. `vibe-image-director` - Generate image prompts
15. `vibe-image-generator` - Execute image generation
16. `vibe-script-writer` - Video scripts
17. `vibe-ebook-writer` - Ebook/guide creation
18. `vibe-orchestrator` - Workflow coordination

#### Agent Service Dependencies
Maps agents to required/optional service capabilities (e.g., vibe-keyword-researcher needs seo_keywords)

**Functions:**
- `export const run = internalMutation({})` - Main seeder (idempotent)
- `export const clearAndReseed = mutation({})` - Wipes tables and re-seeds
- `export const seedMissing = internalMutation({})` - Incremental seeding

### 2. `/var/www/vibe-marketing/scripts/seed-skills.sh` (299 lines)

**What it seeds:**

#### Skill Categories (5 categories) - MORE DETAILED than seed.ts
```bash
L1_audience - "Auto-applied audience awareness routing based on Schwartz levels"
  - selectionMode: "single", allowNone: false
  - pipelineAgentNames: ["vibe-content-writer", "vibe-email-writer", "vibe-social-writer", "vibe-ad-writer"]

L2_offer - "Choose an offer structuring framework"
  - selectionMode: "single", allowNone: true
  - pipelineAgentNames: ["vibe-content-writer", "vibe-landing-page-writer", "vibe-ad-writer", "vibe-email-writer"]

L3_persuasion - "Select one or more persuasion/narrative frameworks"
  - selectionMode: "multiple", allowNone: false
  - pipelineAgentNames: ["vibe-content-writer", "vibe-landing-page-writer", "vibe-ad-writer", "vibe-email-writer", "vibe-social-writer"]

L4_craft - "Choose a primary copy style"
  - selectionMode: "single", allowNone: true
  - pipelineAgentNames: ["vibe-content-writer", "vibe-landing-page-writer", "vibe-email-writer"]

L5_quality - "Auto-applied quality processing"
  - selectionMode: "single", allowNone: false
  - pipelineAgentNames: ["vibe-content-writer", "vibe-email-writer", "vibe-social-writer"]
```

#### Skills (13 skills)

**L1: Audience Understanding (1 skill, auto-active)**
1. `mbook-schwarz-awareness` - Schwartz Awareness Levels (5 Stages × Market Sophistication)
   - isAutoActive: true, isCampaignSelectable: false

**L2: Offer Structure (4 skills, selectable)**
2. `mbook-hormozi-offers` - Hormozi Value Equation
3. `mbook-hormozi-leads` - Hormozi Lead Generation
4. `mbook-brunson-dotcom` - Brunson DotCom Funnels
5. `mbook-brunson-expert` - Brunson Expert Secrets

**L3: Persuasion & Narrative (4 skills, selectable, some with sub-selections)**
6. `mbook-cialdini-influence` - Cialdini Influence Principles
   - subSelections: 7 principles (reciprocity, liking, social_proof, authority, scarcity, commitment, unity)
7. `mbook-voss-negotiation` - Voss Tactical Empathy
8. `mbook-miller-storybrand` - Miller StoryBrand (7-part framework)
9. `mbook-sugarman-copywriting` - Sugarman Psychological Triggers
   - subSelections: 5 triggers (curiosity, storytelling, specificity, urgency, exclusivity)

**L4: Craft/Style (2 skills, selectable)**
10. `mbook-halbert-boron` - Halbert Direct Response
11. `mbook-ogilvy-advertising` - Ogilvy Advertising Craft

**L5: Quality (2 skills, auto-active)**
12. `humanizer` - Removes AI writing patterns (post-processing)
    - isAutoActive: true, isCampaignSelectable: false
13. `writing-clearly-and-concisely` - Strunk-style clarity rules (during generation)
    - isAutoActive: true, isCampaignSelectable: false

**Usage:**
```bash
bash scripts/seed-skills.sh
# Calls: npx convex run skillCategories:upsert + skills:upsertBySlug
```

### 3. `/var/www/vibe-marketing/scripts/seed-skill-categories.sh` (42 lines)

**What it seeds:**

Older, simpler version of skill categories (9 categories) - CONFLICTS with seed.ts:
```bash
L1_audience, L2_offer, L3_persuasion, L4_craft, L5_quality (same as seed.ts)
research, content, media, marketing (additional categories, not in seed.ts)
```

**Note:** This script is likely **deprecated** in favor of the version in `seed.ts` or `seed-skills.sh`.

## Skills on Filesystem

**Location:** `/var/www/vibe-marketing/.claude/skills/`

**Total:** 80 skill directories (22 real directories + 58 symlinks to `.agents/skills/`)

**Marketing Book Skills (11 mbook-* directories):**
1. `mbook-schwarz-awareness/`
2. `mbook-hormozi-offers/`
3. `mbook-hormozi-leads/`
4. `mbook-brunson-dotcom/`
5. `mbook-brunson-expert/`
6. `mbook-cialdini-influence/`
7. `mbook-voss-negotiation/`
8. `mbook-miller-storybrand/`
9. `mbook-sugarman-copywriting/`
10. `mbook-halbert-boron/`
11. `mbook-ogilvy-advertising/`

**Quality Skills (2 directories):**
- `humanizer/`
- `writing-clearly-and-concisely/`

**Procedural Skills (9 directories):**
- `audience-research-procedures/`
- `audience-enrichment-procedures/`
- `audience-analysis-procedures/`
- `content-writing-procedures/`
- `content-review-procedures/`

**Other Skills:** 58 symlinks to community/framework skills (antfu, convex, etc.)

## Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│ SEEDING FLOW                                                │
└─────────────────────────────────────────────────────────────┘

1. Run seed.ts
   ├─> Seed serviceCategories (21)
   ├─> Seed skillCategories (9)  ← Generic version
   ├─> Seed pipelines (6)
   ├─> Seed agents (18)  ← staticSkillIds: [], dynamicSkillIds: []
   └─> Seed agentServiceDeps

2. Run seed-skills.sh
   ├─> Re-upsert skillCategories (5)  ← More detailed L1-L5 version
   └─> Upsert skills (13)  ← mbook-* + humanizer + writing-clearly

3. Manual Assignment (TODO)
   └─> Call agents:updateSkills to populate staticSkillIds/dynamicSkillIds

┌─────────────────────────────────────────────────────────────┐
│ RELATIONSHIPS                                               │
└─────────────────────────────────────────────────────────────┘

agents
  ├─> staticSkillIds: [skillId, skillId, ...]
  └─> dynamicSkillIds: [skillId, skillId, ...]

skills
  └─> category: "L1_audience"  (string reference)

skillCategories
  ├─> key: "L1_audience"
  └─> pipelineAgentNames: ["vibe-content-writer", ...]  (string references)

campaigns
  ├─> activeSkills: [{ skillId, subSelectionKeys? }, ...]
  └─> (selected skills for this campaign)
```

## Gaps & Issues

### 1. Agents Seeded with Empty Skill Arrays
**Problem:** All 18 agents are seeded with `staticSkillIds: []` and `dynamicSkillIds: []`.

**Impact:** Agents have no skills assigned by default. Skills must be manually assigned via `agents:updateSkills`.

**Solution Needed:**
- Add a post-seed step that assigns default skills to agents
- OR: Update `seed.ts` to assign skills after seeding skills table
- OR: Create a mapping script that auto-assigns skills based on agent role

### 2. No Skills Seeded in seed.ts
**Problem:** `seed.ts` seeds agents, pipelines, and categories, but NOT skills. Skills are seeded via separate bash script.

**Impact:** If you only run `npx convex run seed:run`, you get 0 skills in the database.

**Recommendation:** Either:
- Import skill seeding into `seed.ts` as a separate section
- OR: Document that `scripts/seed-skills.sh` MUST be run after seed.ts

### 3. Conflicting Skill Category Definitions
**Problem:** Three sources of truth for skill categories:
- `seed.ts` - 9 categories (generic)
- `seed-skills.sh` - 5 categories (L1-L5, detailed with pipelineAgentNames)
- `seed-skill-categories.sh` - 9 categories (older version)

**Impact:** Depending on run order, categories have different metadata.

**Recommendation:** Choose ONE source of truth:
- Keep `seed-skills.sh` version (most complete)
- Delete `seed-skill-categories.sh` (deprecated)
- Update `seed.ts` to match `seed-skills.sh` categories

### 4. No Agent-Skill Seed Script
**Problem:** No script that populates `agents.staticSkillIds` or `agents.dynamicSkillIds`.

**Gap:** After running all seeds, agents have no skills linked.

**Recommendation:** Create `/var/www/vibe-marketing/scripts/seed-agent-skills.sh`:
```bash
#!/usr/bin/env bash
# Assign default skills to agents after seeding

CONVEX_URL="${CONVEX_URL:-http://localhost:3210}"

# Get skill IDs
SCHWARZ=$(npx convex run skills:getBySlug '{"slug":"mbook-schwarz-awareness"}' --url "$CONVEX_URL" | jq -r '._id')
HUMANIZER=$(npx convex run skills:getBySlug '{"slug":"humanizer"}' --url "$CONVEX_URL" | jq -r '._id')
WRITING=$(npx convex run skills:getBySlug '{"slug":"writing-clearly-and-concisely"}' --url "$CONVEX_URL" | jq -r '._id')

# Assign to vibe-content-writer
WRITER=$(npx convex run agents:getByName '{"name":"vibe-content-writer"}' --url "$CONVEX_URL" | jq -r '._id')
npx convex run agents:updateSkills "{\"id\":\"$WRITER\",\"staticSkillIds\":[\"$SCHWARZ\",\"$HUMANIZER\",\"$WRITING\"]}" --url "$CONVEX_URL"

# ... repeat for other agents
```

### 5. Skills in Filesystem vs Database
**Actual Filesystem:** 80 skill directories (11 mbook + 2 quality + 67 others)
**Seeded in Database:** 13 skills (11 mbook + 2 quality)

**Gap:** 67 skills exist on filesystem but are NOT seeded into database.

**Impact:** Skills like `antfu/*`, `convex/*`, `audience-*-procedures/` are not tracked in Convex.

**Recommendation:**
- Scan `.claude/skills/` directory
- Auto-seed all SKILL.md files into database
- OR: Explicitly decide which skills are "database-tracked" vs "filesystem-only"

### 6. No Skill Category for Procedural Skills
**Problem:** Skills like `audience-research-procedures`, `content-writing-procedures` exist but don't map to any category.

**Gap:** Categories exist (research_method, agent_procedure) but no skills are assigned to them.

**Recommendation:** Seed procedural skills:
```bash
run '{
  "slug": "audience-research-procedures",
  "name": "audience-research-procedures",
  "displayName": "Audience Research Procedures",
  "description": "Step-by-step SOP for audience discovery and profiling",
  "category": "research_method",
  "type": "procedure",
  "isAutoActive": false,
  "isCampaignSelectable": false,
  "filePath": ".claude/skills/audience-research-procedures/SKILL.md"
}'
```

## Recommended Actions

### Priority 1: Fix Agent-Skill Gap
1. Create `scripts/seed-agent-skills.sh` to populate `staticSkillIds`/`dynamicSkillIds`
2. Define default skills per agent role:
   - **Content writers** → Schwartz, Humanizer, Writing Clearly
   - **Email writers** → Schwartz, Voss, Humanizer
   - **Ad writers** → Hormozi Offers, Cialdini, Halbert
   - **Social writers** → Sugarman, Humanizer

### Priority 2: Consolidate Skill Categories
1. Pick ONE source of truth (recommend: `seed-skills.sh`)
2. Remove `seed-skill-categories.sh` (deprecated)
3. Update `seed.ts` to match the detailed L1-L5 categories from `seed-skills.sh`

### Priority 3: Seed Procedural Skills
1. Add procedural skills to `seed-skills.sh`:
   - `audience-research-procedures`
   - `audience-enrichment-procedures`
   - `audience-analysis-procedures`
   - `content-writing-procedures`
   - `content-review-procedures`
2. Assign category: `agent_procedure`

### Priority 4: Document Seeding Order
Create `/var/www/vibe-marketing/scripts/seed-all.sh`:
```bash
#!/usr/bin/env bash
set -euo pipefail

echo "1. Seeding Convex tables (agents, categories, pipelines)..."
npx convex run seed:run --url http://localhost:3210

echo "2. Seeding skills..."
bash scripts/seed-skills.sh

echo "3. Seeding services..."
bash scripts/seed-services.sh

echo "4. Assigning skills to agents..."
bash scripts/seed-agent-skills.sh  # TODO: create this

echo "✓ All seeds complete!"
```

### Priority 5: Auto-Sync Filesystem Skills
Create a sync script that:
1. Scans `.claude/skills/` for SKILL.md files
2. Extracts metadata from frontmatter
3. Calls `skills:upsertBySlug` for each
4. Marks missing files as `syncStatus: "file_missing"`

## Key Files Reference

| File | Purpose | Line Count |
|------|---------|------------|
| `/var/www/vibe-marketing/convex/schema.ts` | Schema definitions (agents, skills, skillCategories) | ~850 |
| `/var/www/vibe-marketing/convex/seed.ts` | Main seeder (agents, categories, pipelines) | 595 |
| `/var/www/vibe-marketing/convex/agents.ts` | Agent CRUD + updateSkills | ~170 |
| `/var/www/vibe-marketing/convex/skills.ts` | Skill CRUD + upsertBySlug | ~200 |
| `/var/www/vibe-marketing/convex/skillCategories.ts` | Category CRUD | 57 |
| `/var/www/vibe-marketing/scripts/seed-skills.sh` | Skills seeder (13 skills) | 299 |
| `/var/www/vibe-marketing/scripts/seed-skill-categories.sh` | Older category seeder (deprecated?) | 42 |
| `/var/www/vibe-marketing/scripts/seed-services.sh` | Service providers seeder | 226 |

## Entry Points for Seeding

```bash
# 1. Seed everything in Convex (agents, categories, pipelines)
npx convex run seed:run --url http://localhost:3210

# 2. Seed skills into Convex
bash scripts/seed-skills.sh

# 3. Seed services into Convex
bash scripts/seed-services.sh

# 4. (MISSING) Assign skills to agents
# No script exists yet - manual calls to agents:updateSkills needed
```

## Database State After Full Seeding

| Table | Count | Notes |
|-------|-------|-------|
| `agents` | 18 | All with empty staticSkillIds/dynamicSkillIds |
| `skills` | 13 | 11 mbook + 2 quality skills |
| `skillCategories` | 5 or 9 | Depends on run order (conflict) |
| `pipelines` | 6 | Preset pipelines |
| `serviceCategories` | 21 | Service capability categories |
| `services` | ~40 | Service providers |
| `agentServiceDeps` | ~20 | Agent → capability mappings |

**Critical Gap:** Agents have NO skills linked after seeding.
